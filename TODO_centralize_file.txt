# TODO: Centralize File Path Handling

## Overview
This document outlines the changes needed to fully centralize file path handling in the easy-podcast codebase. The goal is to ensure that `path_manager.py` is the ONLY place that handles file paths and directories, and that the base data directory is ONLY configurable via the `PODCAST_DATA_DIRECTORY` environment variable.

## Environment Variable Requirement
- **REQUIRED**: Set `PODCAST_DATA_DIRECTORY` environment variable
- **DEFAULT**: If not set, use `"./data"` as the base directory
- **REMOVE**: All other ways to set the data directory (CLI args, function parameters, etc.)

## Files to Modify

### 1. path_manager.py âœ¨ HIGH PRIORITY
**Changes needed:**
- âœ… Add environment variable support in DEFAULT_BASE_DATA_DIR
- âœ… Add missing path methods for mapping files:
  - `get_rss_mapping_path()`
  - `get_podcast_mappings_path()`
  - `get_episode_mappings_path(podcast_guid)`
- âœ… Remove global functions that allow setting base_data_dir
- âœ… Make path_manager the single source of truth for all paths

**Current issues:**
- Uses hardcoded "data" default instead of environment variable
- Missing mapping file path methods
- Global functions allow bypassing centralized control

### 2. mapping_manager.py ğŸ”´ CRITICAL
**Changes needed:**
- âŒ REMOVE all hardcoded path construction from __init__()
- âŒ REMOVE direct os.path.join() usage
- âŒ REMOVE os.makedirs() calls
- âœ… Use path_manager for ALL file paths
- âœ… Accept path_manager as constructor parameter

**Current issues:**
- Lines 21-26: Hardcoded mapping file paths
- Lines 135-139: Direct path construction for episode mappings
- Lines 188-192: Direct path construction for episode mappings
- Lines 174-177: Direct os.makedirs() usage

### 3. downloader.py ğŸ”´ CRITICAL
**Changes needed:**
- âŒ REMOVE target_download_dir parameters
- âŒ REMOVE direct os.path.join() usage (lines 68-72, 178-220)
- âœ… Accept path_manager and podcast_guid parameters instead
- âœ… Use path_manager.get_episode_audio_path() for all paths
- âœ… Use path_manager.ensure_episode_dir_exists() for directory creation

**Current issues:**
- Functions take directory paths as parameters
- Direct file path construction in download_file_streamed()
- No integration with centralized path management

### 4. manager.py ğŸŸ¡ MEDIUM PRIORITY
**Changes needed:**
- âŒ REMOVE get_downloads_dir_for_episode() method
- âœ… Update download_episode() to pass path_manager to downloader
- âœ… Ensure all path operations go through path_manager

**Current issues:**
- get_downloads_dir_for_episode() uses os.path.dirname() directly
- Some redundant path wrapper methods

### 5. cli.py ğŸŸ¡ MEDIUM PRIORITY
**Changes needed:**
- âŒ REMOVE --data-dir command line argument
- âŒ REMOVE set_base_data_dir() call
- âœ… Add validation that PODCAST_DATA_DIRECTORY is set
- âœ… Show clear error if environment variable missing

**Current issues:**
- Allows setting data directory via CLI argument
- Should only use environment variable

### 6. storage_manager.py âœ… ALREADY GOOD
**Status:** Already properly centralized
- Uses path_manager for all file paths
- No direct path construction
- Good example of proper architecture

### 7. models.py âœ… ALREADY GOOD
**Status:** Clean data objects
- No filepath responsibilities
- Only has filename properties (not full paths)
- Proper separation of concerns

## Implementation Steps

### Phase 1: Core Infrastructure (CRITICAL)
1. âœ… Update path_manager.py to use PODCAST_DATA_DIRECTORY environment variable
2. âœ… Add missing mapping file path methods to path_manager.py
3. âœ… Remove global path configuration functions

### Phase 2: Remove Hardcoded Paths (CRITICAL)
4. âœ… Refactor mapping_manager.py to use path_manager for all paths
5. âœ… Update mapping_manager constructor to accept path_manager

### Phase 3: Centralize Download Operations (CRITICAL)
6. âœ… Refactor downloader.py functions to use path_manager
7. âœ… Remove directory parameters from download functions
8. âœ… Update all callers of download functions

### Phase 4: Clean Up Manager and CLI (MEDIUM)
9. âœ… Update manager.py to use new downloader interface
10. âœ… Remove direct path operations from manager.py
11. âœ… Update cli.py to only use environment variable

### Phase 5: Testing and Validation (HIGH)
12. âœ… Update test files to work with new architecture
13. âœ… Run all tests to ensure functionality works
14. âœ… Validate that only environment variable controls data directory

## Expected Benefits
- âœ… Single source of truth for all file paths
- âœ… Consistent path handling across entire codebase
- âœ… Easier testing with path injection
- âœ… Clear configuration via environment variable only
- âœ… Reduced coupling between components
- âœ… Better separation of concerns

## Files That Should NOT Change
- utils.py âœ… (only has filename sanitization, no paths)
- parser.py âœ… (no file path operations)
- models.py âœ… (clean data objects)

## Validation Checklist
After implementation, verify:
- [ ] Only path_manager.py contains os.path operations
- [ ] Only PODCAST_DATA_DIRECTORY environment variable sets base directory
- [ ] All file operations go through path_manager
- [ ] No hardcoded paths anywhere in codebase
- [ ] All tests pass
- [ ] CLI shows clear error if PODCAST_DATA_DIRECTORY not set
- [ ] mapping_manager uses path_manager for all paths
- [ ] downloader uses path_manager for all paths

## Risk Areas
- **mapping_manager.py**: Heavy refactoring needed, many path operations
- **downloader.py**: Function signatures will change, affects callers
- **Test compatibility**: Tests may need updates for new architecture
- **Backward compatibility**: Removing CLI --data-dir argument is breaking change

---
**PRIORITY ORDER:**
1. ğŸ”´ CRITICAL: path_manager.py environment variable support
2. ğŸ”´ CRITICAL: mapping_manager.py refactoring
3. ğŸ”´ CRITICAL: downloader.py refactoring
4. ğŸŸ¡ MEDIUM: manager.py cleanup
5. ğŸŸ¡ MEDIUM: cli.py updates
6. ğŸŸ¢ LOW: Test updates